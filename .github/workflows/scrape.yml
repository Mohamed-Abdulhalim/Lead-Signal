name: Scrape

on:
  schedule:
    - cron: "0 */04 * * *"
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset city rotation to the top"
        type: boolean
        required: false
        default: false

concurrency:
  group: scrape
  cancel-in-progress: false

permissions:
  contents: write   # needed to commit the rotation_index.txt

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # we’re going to commit a tiny state file

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Pick city for this run (using persistent rotation)
        id: pick
        shell: bash
        env:
          RESET: ${{ github.event.inputs.reset }}
        run: |
          state_file=".github/rotation_index.txt"

          mapfile -t cities <<'EOF'          
          London, United Kingdom
          Manchester, United Kingdom
          Birmingham, United Kingdom
          Leeds, United Kingdom
          Liverpool, United Kingdom
          Bristol, United Kingdom
          Edinburgh, United Kingdom
          Glasgow, United Kingdom
          Dublin, Ireland
          Paris, France
          Lyon, France
          Marseille, France
          Nice, France
          Toulouse, France
          Berlin, Germany
          Hamburg, Germany
          Munich, Germany
          Frankfurt, Germany
          Cologne, Germany
          Düsseldorf, Germany
          Amsterdam, Netherlands
          Rotterdam, Netherlands
          Utrecht, Netherlands
          The Hague, Netherlands
          Madrid, Spain
          Barcelona, Spain
          Valencia, Spain
          Seville, Spain
          Milan, Italy
          Rome, Italy
          Turin, Italy
          Naples, Italy
          Florence, Italy
          Venice, Italy
          Zurich, Switzerland
          Geneva, Switzerland
          Basel, Switzerland
          Vienna, Austria
          Prague, Czech Republic
          Warsaw, Poland
          Kraków, Poland
          Wrocław, Poland
          Budapest, Hungary
          Brussels, Belgium
          Antwerp, Belgium
          Stockholm, Sweden
          Gothenburg, Sweden
          Oslo, Norway
          Bergen, Norway
          Copenhagen, Denmark
          Helsinki, Finland
          Lisbon, Portugal
          Porto, Portugal
          Athens, Greece
          Thessaloniki, Greece
          Bucharest, Romania
          Cluj-Napoca, Romania
          Sofia, Bulgaria
          Belgrade, Serbia
          Zagreb, Croatia
          Ljubljana, Slovenia
          Tallinn, Estonia
          Riga, Latvia
          Vilnius, Lithuania
          Dubai, United Arab Emirates
          Abu Dhabi, United Arab Emirates
          Sharjah, United Arab Emirates
          Riyadh, Saudi Arabia
          Jeddah, Saudi Arabia
          Dammam, Saudi Arabia
          Khobar, Saudi Arabia
          Mecca, Saudi Arabia
          Medina, Saudi Arabia
          Doha, Qatar
          Manama, Bahrain
          Kuwait City, Kuwait
          Muscat, Oman
          Amman, Jordan
          Istanbul, Turkey
          Ankara, Turkey
          Izmir, Turkey
          Bursa, Turkey
          Tokyo, Japan
          Osaka, Japan
          Kyoto, Japan
          Yokohama, Japan
          Nagoya, Japan
          Seoul, South Korea
          Busan, South Korea
          Incheon, South Korea
          Shanghai, China
          Beijing, China
          Shenzhen, China
          Guangzhou, China
          Hangzhou, China
          Chengdu, China
          Hong Kong, China
          Macau, China
          Taipei, Taiwan
          Kaohsiung, Taiwan
          Singapore, Singapore
          Kuala Lumpur, Malaysia
          Penang, Malaysia
          Bangkok, Thailand
          Chiang Mai, Thailand
          Phuket, Thailand
          Jakarta, Indonesia
          Surabaya, Indonesia
          Bandung, Indonesia
          Bali, Indonesia
          Manila, Philippines
          Cebu City, Philippines
          Davao City, Philippines
          Ho Chi Minh City, Vietnam
          Hanoi, Vietnam
          Da Nang, Vietnam
          Mumbai, India
          Delhi, India
          Bangalore, India
          Hyderabad, India
          Chennai, India
          Pune, India
          Ahmedabad, India
          Kolkata, India
          Islamabad, Pakistan
          Karachi, Pakistan
          Lahore, Pakistan
          Dhaka, Bangladesh
          Colombo, Sri Lanka
          Sydney, Australia
          Melbourne, Australia
          Brisbane, Australia
          Perth, Australia
          Adelaide, Australia
          Gold Coast, Australia
          Auckland, New Zealand
          Wellington, New Zealand
          Christchurch, New Zealand
          São Paulo, Brazil
          Rio de Janeiro, Brazil
          Belo Horizonte, Brazil
          Curitiba, Brazil
          Porto Alegre, Brazil
          Mexico City, Mexico
          Guadalajara, Mexico
          Monterrey, Mexico
          Cancún, Mexico
          Bogotá, Colombia
          Medellín, Colombia
          Cali, Colombia
          Lima, Peru
          Santiago, Chile
          Valparaíso, Chile
          Buenos Aires, Argentina
          Córdoba, Argentina
          Rosario, Argentina
          Montevideo, Uruguay
          Asunción, Paraguay
          La Paz, Bolivia
          Santa Cruz de la Sierra, Bolivia
          Johannesburg, South Africa
          Cape Town, South Africa
          Durban, South Africa
          Pretoria, South Africa
          Nairobi, Kenya
          Mombasa, Kenya
          Lagos, Nigeria
          Abuja, Nigeria
          Ibadan, Nigeria
          Accra, Ghana
          Kumasi, Ghana
          Casablanca, Morocco
          Rabat, Morocco
          Marrakesh, Morocco
          Tangier, Morocco
          Tunis, Tunisia
          Algiers, Algeria
          Dakar, Senegal
          Abidjan, Ivory Coast
          Addis Ababa, Ethiopia
          # ... rest commented cities ...
          EOF

          filtered=()
          for c in "${cities[@]}"; do
            [[ -z "$c" ]] && continue
            [[ "$c" =~ ^# ]] && continue
            filtered+=("$c")
          done

          count=${#filtered[@]}
          if [[ $count -eq 0 ]]; then
            echo "No cities configured"; exit 1
          fi

          if [[ "$RESET" == "true" ]]; then
            idx=0
          elif [[ -f "$state_file" ]]; then
            read -r idx < "$state_file" || idx=0
          else
            idx=0
          fi

          if (( idx < 0 || idx >= count )); then
            idx=0
          fi

          city="${filtered[$idx]}"
          echo "CITY=$city" >> "$GITHUB_ENV"
          safe="$(echo "$city" | tr '[:space:]/,' '_')"
          echo "CITY_SAFE=$safe" >> "$GITHUB_ENV"

          next_idx=$(( (idx + 1) % count ))
          mkdir -p "$(dirname "$state_file")"
          echo "$next_idx" > "$state_file"

          echo "Picked city: $city (index $idx of $count). Next index will be $next_idx."

      - name: Persist rotation index
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/rotation_index.txt
          git commit -m "chore: advance rotation index to ${{ env.CITY_SAFE }}" || echo "No changes to commit"
          git push

      - name: Run full pipeline for selected city
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          echo "Running pipeline for: $CITY"
          python pipeline.py \
            --location "$CITY" \
            --categories-file categories.txt \
            --out-prefix "gha_${CITY_SAFE}"

      - name: Upload enriched CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: enriched_csv_${{ env.CITY_SAFE }}
          path: gha_${{ env.CITY_SAFE }}_enriched.csv
