name: Scrape

on:
  schedule:
    - cron: "0 */04 * * *"
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset city rotation to the top"
        type: boolean
        required: false
        default: false

concurrency:
  group: scrape
  cancel-in-progress: false

permissions:
  contents: write   # needed to commit the rotation_index.txt

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # we’re going to commit a tiny state file

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Pick city for this run (using persistent rotation)
        id: pick
        shell: bash
        env:
          RESET: ${{ github.event.inputs.reset }}
        run: |
          state_file=".github/rotation_index.txt"

          mapfile -t cities <<'EOF'
          Toronto, Canada  
          Montreal, Canada  
          Vancouver, Canada  
          Calgary, Canada  
          Edmonton, Canada  
          Ottawa, Canada  
          Winnipeg, Canada  
          Quebec City, Canada  
          Hamilton, Canada  
          Kitchener, Canada  
          London, Canada  
          Mississauga, Canada  
          Brampton, Canada  
          Surrey, Canada  
          Halifax, Canada  
          Victoria, Canada  
          Saskatoon, Canada  
          Regina, Canada  
          St. John's, Canada  
          Laval, Canada  
          Gatineau, Canada  
          Longueuil, Canada  
          Windsor, Canada  
          Burnaby, Canada  
          Markham, Canada  
          Vaughan, Canada  
          Oakville, Canada  
          Richmond, Canada  
          Richmond Hill, Canada  
          Burlington, Canada  
          Barrie, Canada  
          Kelowna, Canada  
          Sherbrooke, Canada  
          Trois-Rivières, Canada  
          Red Deer, Canada  
          Lethbridge, Canada  
          St. Albert, Canada  
          Medicine Hat, Canada  
          Greater Sudbury, Canada  
          Thunder Bay, Canada  
          Whitehorse, Canada  
          Yellowknife, Canada  
          Charlottetown, Canada  
          Fredericton, Canada  
          Saint John, Canada  
          Moncton, Canada  
          Bathurst, Canada  
          Corner Brook, Canada  
          Prince Albert, Canada  
          Moose Jaw, Canada  
          Steinbach, Canada  
          Thompson, Canada  
          Brandon, Canada  
          Summerside, Canada  
          Iqaluit, Canada  
          # ... rest commented cities ...
          EOF

          filtered=()
          for c in "${cities[@]}"; do
            [[ -z "$c" ]] && continue
            [[ "$c" =~ ^# ]] && continue
            filtered+=("$c")
          done

          count=${#filtered[@]}
          if [[ $count -eq 0 ]]; then
            echo "No cities configured"; exit 1
          fi

          if [[ "$RESET" == "true" ]]; then
            idx=0
          elif [[ -f "$state_file" ]]; then
            read -r idx < "$state_file" || idx=0
          else
            idx=0
          fi

          if (( idx < 0 || idx >= count )); then
            idx=0
          fi

          city="${filtered[$idx]}"
          echo "CITY=$city" >> "$GITHUB_ENV"
          safe="$(echo "$city" | tr '[:space:]/,' '_')"
          echo "CITY_SAFE=$safe" >> "$GITHUB_ENV"

          next_idx=$(( (idx + 1) % count ))
          mkdir -p "$(dirname "$state_file")"
          echo "$next_idx" > "$state_file"

          echo "Picked city: $city (index $idx of $count). Next index will be $next_idx."

      - name: Persist rotation index
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/rotation_index.txt
          git commit -m "chore: advance rotation index to ${{ env.CITY_SAFE }}" || echo "No changes to commit"
          git push

      - name: Run full pipeline for selected city
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          echo "Running pipeline for: $CITY"
          python pipeline.py \
            --location "$CITY" \
            --categories-file categories.txt \
            --out-prefix "gha_${CITY_SAFE}"

      - name: Upload enriched CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: enriched_csv_${{ env.CITY_SAFE }}
          path: gha_${{ env.CITY_SAFE }}_enriched.csv
